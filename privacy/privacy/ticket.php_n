<?php
// ticket.php - Interfaccia Cliente + IA
include 'config.php';

// 1. VERIFICA SICUREZZA
if (!isset($_GET['t'])) die("Accesso Negato.");
$token = $_GET['t'];

// Recupera info Ticket
$stmt = $conn->prepare("SELECT * FROM m35_tickets WHERE token = ?");
$stmt->bind_param("s", $token);
$stmt->execute();
$ticket = $stmt->get_result()->fetch_assoc();

if (!$ticket) die("Ticket non trovato.");

// 2. GESTIONE MESSAGGI (Se l'utente scrive)
if ($_SERVER['REQUEST_METHOD'] === 'POST' && !empty($_POST['messaggio'])) {
    $msg_utente = $_POST['messaggio'];
    
    // Salva messaggio UTENTE
    $stmt = $conn->prepare("INSERT INTO m35_chat (ticket_id, sender, messaggio) VALUES (?, 'CLIENTE', ?)");
    $stmt->bind_param("is", $ticket['id'], $msg_utente);
    $stmt->execute();

    // --- CERVELLO IA (GEMINI) ---
    
    // A. Recupera la storia precedente (Context)
    $history_query = "SELECT sender, messaggio FROM m35_chat WHERE ticket_id = " . $ticket['id'] . " ORDER BY id ASC";
    $history_res = $conn->query($history_query);
    
    $chat_history = "";
    while($row = $history_res->fetch_assoc()) {
        $chat_history .= $row['sender'] . ": " . $row['messaggio'] . "\n";
    }

    // B. Prompt di Sistema (Chi √® l'IA)
    $system_prompt = "
    Sei l'Assistente Virtuale 'M 3.5 AI' della societ√† M 3.5 S.R.L. (Legal Tech & E-commerce).
    Parli con il cliente: " . $ticket['cliente'] . ".
    Oggetto del ticket: " . $ticket['oggetto'] . ".
    
    TUA MISSIONE:
    1. Rispondi in modo professionale ma empatico.
    2. Se il cliente fornisce dati critici (Tracking, Foto, Codici), conferma di averli ricevuti e salvati.
    3. Usa la STORIA DELLA CHAT qui sotto per capire il contesto. Non ripeterti.
    
    STORIA DELLA CHAT:
    $chat_history
    
    RISPONDI AL CLIENTE (Sii conciso):
    ";

    // C. Chiamata API Gemini
    $data = ["contents" => [["parts" => [["text" => $system_prompt]]]]];
    $options = [
        'http' => [
            'header'  => "Content-type: application/json\r\n",
            'method'  => 'POST',
            'content' => json_encode($data)
        ]
    ];
    $context  = stream_context_create($options);
    $url = "https://generativelanguage.googleapis.com/v1beta/models/gemini-3-flash-preview:generateContent?key=" . $gemini_api_key;
    $result = file_get_contents($url, false, $context);
    $response = json_decode($result, true);
    
    // Pulizia Risposta IA
    $ai_reply = $response['candidates'][0]['content']['parts'][0]['text'];

    // D. Salva risposta IA
    $stmt = $conn->prepare("INSERT INTO m35_chat (ticket_id, sender, messaggio) VALUES (?, 'AI', ?)");
    $stmt->bind_param("is", $ticket['id'], $ai_reply);
    $stmt->execute();
    
    // Refresh pagina per vedere i messaggi
    header("Location: ticket.php?t=" . $token);
    exit;
}

// 3. RECUPERA MESSAGGI PER VISUALIZZAZIONE
$chat_res = $conn->query("SELECT * FROM m35_chat WHERE ticket_id = " . $ticket['id'] . " ORDER BY id ASC");
?>

<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0"> <title>Supporto M 3.5 - Ticket #<?php echo $ticket['id']; ?></title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background: #eef1f5; margin: 0; display: flex; flex-direction: column; height: 100vh; }
        
        /* HEADER */
        .header { background: #081014; color: white; padding: 15px; display: flex; justify-content: space-between; align-items: center; border-bottom: 4px solid #00D185; }
        .header h1 { margin: 0; font-size: 18px; }
        .header span { font-size: 12px; color: #00D185; text-transform: uppercase; letter-spacing: 1px; }

        /* CHAT AREA */
        .chat-container { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 15px; }
        
        .msg { max-width: 80%; padding: 12px 18px; border-radius: 12px; font-size: 15px; line-height: 1.4; position: relative; }
        
        .msg-CLIENTE { align-self: flex-end; background: #00D185; color: white; border-bottom-right-radius: 2px; }
        .msg-AI { align-self: flex-start; background: white; color: #333; border: 1px solid #ddd; border-bottom-left-radius: 2px; }
        .msg-ADMIN { align-self: flex-start; background: #081014; color: white; border-bottom-left-radius: 2px; }
        
        .sender-name { font-size: 10px; opacity: 0.7; margin-bottom: 4px; display: block; font-weight: bold; text-transform: uppercase; }

        /* INPUT AREA */
        .input-area { background: white; padding: 15px; border-top: 1px solid #ddd; display: flex; gap: 10px; }
        textarea { flex: 1; padding: 12px; border: 2px solid #ddd; border-radius: 8px; resize: none; height: 50px; font-family: inherit; }
        textarea:focus { border-color: #00D185; outline: none; }
        button { background: #081014; color: white; border: none; padding: 0 25px; border-radius: 8px; font-weight: bold; cursor: pointer; transition: 0.2s; }
        button:hover { background: #00D185; }

        /* BUTTON PRINT */
        .btn-print { background: transparent; border: 1px solid #00D185; color: #00D185; padding: 5px 10px; border-radius: 4px; font-size: 12px; text-decoration: none; }
    </style>
</head>
<body>

    <div class="header">
        <div>
            <span>M 3.5 Supporto Tecnico</span>
            <h1><?php echo $ticket['oggetto']; ?></h1>
        </div>
        <a href="javascript:window.print()" class="btn-print">üñ®Ô∏è Salva Report</a>
    </div>

    <div class="chat-container" id="chatBox">
        <div class="msg msg-AI">
            <span class="sender-name">M 3.5 AI SYSTEM</span>
            Salve <?php echo $ticket['cliente']; ?>. Sono l'assistente virtuale di M 3.5. Come posso aiutarti oggi riguardo alla pratica in oggetto?
        </div>

        <?php while($row = $chat_res->fetch_assoc()): ?>
            <div class="msg msg-<?php echo $row['sender']; ?>">
                <span class="sender-name">
                    <?php echo ($row['sender'] == 'CLIENTE') ? 'TU' : (($row['sender'] == 'AI') ? 'M 3.5 AI' : 'Massimo (Admin)'); ?>
                </span>
                <?php echo nl2br(htmlspecialchars($row['messaggio'])); ?>
            </div>
        <?php endwhile; ?>
    </div>

    <form class="input-area" method="POST">
        <textarea name="messaggio" placeholder="Scrivi qui..." required></textarea>
        <button type="submit">INVIA ‚û§</button>
    </form>

    <script>
        // Auto-scroll verso il basso all'apertura
        var chatBox = document.getElementById("chatBox");
        chatBox.scrollTop = chatBox.scrollHeight;
    </script>

</body>
</html>