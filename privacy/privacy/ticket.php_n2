<?php
// ticket.php - VERSIONE V2 (Con Admin Mode)
include 'config.php';

// 1. VERIFICA PARAMETRI
if (!isset($_GET['t'])) die("Accesso Negato.");
$token = $_GET['t'];

// SEI L'AMMINISTRATORE? (Controllo "Magic Link")
$is_admin = (isset($_GET['admin']) && $_GET['admin'] == '1');

// Recupera info Ticket
$stmt = $conn->prepare("SELECT * FROM m35_tickets WHERE token = ?");
$stmt->bind_param("s", $token);
$stmt->execute();
$ticket = $stmt->get_result()->fetch_assoc();

if (!$ticket) die("Ticket non trovato.");

// 2. GESTIONE INVIO MESSAGGI
if ($_SERVER['REQUEST_METHOD'] === 'POST' && !empty($_POST['messaggio'])) {
    $msg_utente = $_POST['messaggio'];
    
    // Se sei Admin, il sender √® ADMIN, altrimenti √® CLIENTE
    $sender = $is_admin ? 'ADMIN' : 'CLIENTE';

    // Salva messaggio
    $stmt = $conn->prepare("INSERT INTO m35_chat (ticket_id, sender, messaggio) VALUES (?, ?, ?)");
    $stmt->bind_param("iss", $ticket['id'], $sender, $msg_utente);
    $stmt->execute();

    // --- CERVELLO IA (GEMINI) ---
    // L'IA risponde SOLO se ha scritto il CLIENTE. Se scrive l'Admin, l'IA sta zitta.
    if (!$is_admin) {
        
        // A. Recupera la storia
        $history_query = "SELECT sender, messaggio FROM m35_chat WHERE ticket_id = " . $ticket['id'] . " ORDER BY id ASC";
        $history_res = $conn->query($history_query);
        $chat_history = "";
        while($row = $history_res->fetch_assoc()) {
            $chat_history .= $row['sender'] . ": " . $row['messaggio'] . "\n";
        }

        // B. Prompt
        $system_prompt = "
        Sei l'Assistente 'M 3.5 AI'. Parli con: " . $ticket['cliente'] . ".
        Oggetto: " . $ticket['oggetto'] . ".
        
        TUA MISSIONE:
        Rispondi al cliente in modo professionale.
        Se il cliente fornisce dati (tracking, foto), conferma ricezione.
        
        STORIA CHAT:
        $chat_history
        
        RISPONDI AL CLIENTE (Sii conciso):
        ";

        // C. Chiamata API
        $data = ["contents" => [["parts" => [["text" => $system_prompt]]]]];
        $options = [
            'http' => [
                'header'  => "Content-type: application/json\r\n",
                'method'  => 'POST',
                'content' => json_encode($data)
            ]
        ];
        $context  = stream_context_create($options);
        $url = "https://generativelanguage.googleapis.com/v1beta/models/gemini-3-flash-preview:generateContent?key=" . $gemini_api_key;
        $result = file_get_contents($url, false, $context);
        $response = json_decode($result, true);
        $ai_reply = $response['candidates'][0]['content']['parts'][0]['text'];

        // D. Salva risposta IA
        $stmt = $conn->prepare("INSERT INTO m35_chat (ticket_id, sender, messaggio) VALUES (?, 'AI', ?)");
        $stmt->bind_param("is", $ticket['id'], $ai_reply);
        $stmt->execute();
    }
    
    // Refresh pagina (mantiene l'admin mode se c'era)
    $refresh_link = "ticket.php?t=" . $token . ($is_admin ? "&admin=1" : "");
    header("Location: " . $refresh_link);
    exit;
}

// 3. RECUPERA MESSAGGI
$chat_res = $conn->query("SELECT * FROM m35_chat WHERE ticket_id = " . $ticket['id'] . " ORDER BY id ASC");
?>

<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Supporto M 3.5 - Ticket #<?php echo $ticket['id']; ?></title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background: #eef1f5; margin: 0; display: flex; flex-direction: column; height: 100vh; }
        
        /* HEADER: Cambia colore se sei ADMIN */
        .header { 
            background: <?php echo $is_admin ? '#d32f2f' : '#081014'; ?>; 
            color: white; padding: 15px; display: flex; justify-content: space-between; align-items: center; border-bottom: 4px solid #00D185; 
        }
        .header h1 { margin: 0; font-size: 18px; }
        .header span { font-size: 12px; color: #fff; text-transform: uppercase; letter-spacing: 1px; font-weight:bold; }

        .chat-container { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 15px; }
        
        .msg { max-width: 80%; padding: 12px 18px; border-radius: 12px; font-size: 15px; line-height: 1.4; position: relative; }
        
        /* STILI MESSAGGI */
        .msg-CLIENTE { align-self: flex-start; background: #fff; color: #333; border: 1px solid #ccc; border-bottom-left-radius: 2px; }
        .msg-AI { align-self: flex-start; background: #e0f2f1; color: #00695c; border: 1px solid #b2dfdb; border-bottom-left-radius: 2px; margin-left: 20px;}
        
        /* I tuoi messaggi (ADMIN) o quelli del cliente (se visti da lui) cambiano lato */
        <?php if ($is_admin): ?>
            .msg-CLIENTE { align-self: flex-start; }
            .msg-ADMIN { align-self: flex-end; background: #d32f2f; color: white; border-bottom-right-radius: 2px; }
        <?php else: ?>
            .msg-CLIENTE { align-self: flex-end; background: #00D185; color: white; border-bottom-right-radius: 2px; }
            .msg-ADMIN { align-self: flex-start; background: #081014; color: white; border-bottom-left-radius: 2px; }
        <?php endif; ?>

        .sender-name { font-size: 10px; opacity: 0.7; margin-bottom: 4px; display: block; font-weight: bold; text-transform: uppercase; }

        .input-area { background: white; padding: 15px; border-top: 1px solid #ddd; display: flex; gap: 10px; }
        textarea { flex: 1; padding: 12px; border: 2px solid #ddd; border-radius: 8px; resize: none; height: 50px; font-family: inherit; }
        textarea:focus { border-color: #00D185; outline: none; }
        
        button { 
            background: <?php echo $is_admin ? '#d32f2f' : '#081014'; ?>; 
            color: white; border: none; padding: 0 25px; border-radius: 8px; font-weight: bold; cursor: pointer; 
        }

        .admin-badge { background: white; color: #d32f2f; padding: 2px 5px; border-radius: 3px; font-size: 10px; font-weight: bold; margin-left: 10px; }
    </style>
</head>
<body>

    <div class="header">
        <div>
            <span>M 3.5 Supporto <?php if($is_admin) echo '<span class="admin-badge">ADMIN MODE</span>'; ?></span>
            <h1><?php echo $ticket['oggetto']; ?></h1>
        </div>
        <a href="javascript:window.print()" style="color:white; text-decoration:none;">üñ®Ô∏è</a>
    </div>

    <div class="chat-container" id="chatBox">
        <?php while($row = $chat_res->fetch_assoc()): ?>
            <div class="msg msg-<?php echo $row['sender']; ?>">
                <span class="sender-name"><?php echo $row['sender']; ?></span>
                <?php echo nl2br(htmlspecialchars($row['messaggio'])); ?>
            </div>
        <?php endwhile; ?>
    </div>

    <form class="input-area" method="POST">
        <textarea name="messaggio" placeholder="<?php echo $is_admin ? 'Scrivi come Massimo (Admin)...' : 'Scrivi qui...'; ?>" required></textarea>
        <button type="submit">INVIA ‚û§</button>
    </form>

    <script>
        var chatBox = document.getElementById("chatBox");
        chatBox.scrollTop = chatBox.scrollHeight;
    </script>
</body>
</html>